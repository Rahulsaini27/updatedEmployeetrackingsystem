{% extends 'OrgDashboard.html' %}
{% block dashboard_content %}
{% load custom_perms %} {# Add this line #}

{# Custom styles for this page to align with the layout.html theme variables #}
<style>
    /* Global color variables from layout.html */
    :root {
        --primary-purple: #37474F; /* Dark Greyish Blue - main sidebar/navbar */
        --text-light: #FFFFFF; /* White text on dark backgrounds */
        --text-dark: #212121; /* Very Dark Grey - text on light backgrounds */
        --bg-light-grey: #F8F9FA; /* Very Light Grey - overall page background */
        --card-bg-white: #FFFFFF; /* White - background for cards/content blocks */

        /* NEW: Secondary grey-blue for accents like edit buttons */
        --secondary-grey-blue: #B0BEC5; /* A lighter shade of blue-grey */
    }

    /* Override Bootstrap primary button to use the theme's dark purple */
    .btn-primary {
        background-color: var(--primary-purple) !important; /* Dark Greyish Blue */
        border-color: var(--primary-purple) !important;
        color: var(--text-light) !important; /* Ensure text is white */
    }
    .btn-primary:hover, .btn-primary:focus {
        background-color: rgba(55, 71, 79, 0.85) !important; /* Slightly lighter primary-purple on hover */
        border-color: rgba(55, 71, 79, 0.85) !important;
    }

    /* Custom button for 'Edit' action - using the new secondary grey-blue */
    .btn-custom-edit {
        background-color: var(--secondary-grey-blue) !important; /* Light blue-grey */
        border-color: var(--secondary-grey-blue) !important;
        color: var(--text-dark) !important; /* Dark text for contrast on light background */
    }
    .btn-custom-edit:hover, .btn-custom-edit:focus {
        background-color: rgba(176, 190, 197, 0.9) !important; /* Slightly darker secondary-grey-blue on hover */
        border-color: rgba(176, 190, 197, 0.9) !important;
    }

    /* Table header styling for consistency with the dark theme */
    #permissions-table thead {
        background-color: var(--primary-purple); /* Dark background */
        color: var(--text-light); /* White text */
    }
    #permissions-table th {
        color: var(--text-light) !important; /* Ensure all th text is white */
        border-bottom: 1px solid rgba(255,255,255,0.2) !important; /* Light border for separation */
    }

    /* Table row hover effect */
    #permissions-table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03); /* Subtle light grey hover */
    }

    /* Adjust form-control focus style to match theme primary-purple */
    .form-control:focus {
        border-color: var(--primary-purple);
        box-shadow: 0 0 0 0.25rem rgba(55, 71, 79, 0.25); /* Primary purple glow */
    }

    /* Card backgrounds should be white and text dark as per layout */
    .card {
        background-color: var(--card-bg-white) !important;
        color: var(--text-dark);
    }
    .card-header, h3, label {
        color: var(--text-dark) !important; /* Ensure headings and labels are dark */
    }
    .form-text.text-muted {
        color: rgba(0, 0, 0, 0.6) !important; /* Make muted text slightly darker for readability */
    }

    /* Style for the <code> tag inside table cells */
    table td code {
        background-color: var(--bg-light-grey); /* Light grey background for code */
        padding: 0.2em 0.4em;
        border-radius: 0.25rem;
        font-size: 87.5%;
        color: var(--text-dark); /* Dark text for code */
    }
    
    /* Ensure DataTables specific elements align with the theme */
    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select {
        border: 1px solid #ced4da; /* Bootstrap default border color */
        padding: 0.375rem 0.75rem; /* Bootstrap default padding */
        border-radius: 0.25rem; /* Bootstrap default border-radius */
        background-color: var(--card-bg-white);
        color: var(--text-dark);
    }
    .dataTables_wrapper .dataTables_filter label,
    .dataTables_wrapper .dataTables_length label,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        color: var(--text-dark) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
        background-color: var(--primary-purple) !important; /* Dark purple for active pagination */
        border-color: var(--primary-purple) !important;
        color: var(--text-light) !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
        color: rgba(0, 0, 0, 0.4) !important;
    }
    .dt-buttons .btn {
        background-color: var(--primary-purple) !important; /* Dark purple buttons */
        color: var(--text-light) !important; /* White text */
        border-color: var(--primary-purple) !important;
        margin-right: 0.25rem; /* Small spacing between buttons */
    }
    .dt-buttons .btn:hover {
        background-color: rgba(55, 71, 79, 0.9) !important; /* Slightly darker on hover */
        border-color: rgba(55, 71, 79, 0.9) !important;
    }
</style>

<div class="row justify-content-center pt-4">
    <div class="col-12 mb-4">
        <div class="card shadow rounded-4 border-0 p-4 mb-4"> {# Added mb-4 for spacing between sections #}
            <div class="card-header border-0 pb-0 bg-transparent"> {# Removed border, background, and padding from header #}
                <h3 class="h3 text-center mb-4">Add New Permission</h3> {# Centered heading #}
            </div>
            <div class="card-body pt-0"> {# Adjusted padding #}
                <form action="{% url 'create-permission' %}" method="POST">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                <label class="form-label" for="codename">Codename</label>
                                <input class="form-control" id="codename" name="codename" type="text" placeholder="e.g., view_logs" required>
                                <small class="form-text text-muted">A unique code, no spaces.</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-group">
                                <label class="form-label" for="name">Display Name</label>
                                <input class="form-control" id="name" name="name" type="text" placeholder="e.g., View Logs" required>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4"> {# mb-4 for final form group before button #}
                            <div class="form-group">
                                <label class="form-label" for="description">Description (Optional)</label>
                                <input class="form-control" id="description" name="description" type="text" placeholder="e.g., Allows viewing system logs">
                            </div>
                        </div>
                    </div>
                    <div class="d-grid"> {# Full width button #}
                        <button type="submit" class="btn btn-primary btn-lg">Add Permission</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card shadow rounded-4 border-0 p-4">
            <div class="card-header border-0 pb-0 bg-transparent">
                <h3 class="h3 text-center mb-4">Existing Permissions</h3>
            </div>
            <div class="card-body pt-0">
                <div class="table-responsive">
                    <table id="permissions-table" class="table table-hover table-centered table-nowrap mb-0 rounded"> {# Added table-hover #}
                        <thead> {# Removed thead-light class, styling handled by custom CSS #}
                            <tr>
                                <th class="border-0">Codename</th>
                                <th class="border-0">Name</th>
                                <th class="border-0">Description</th>
                                <th class="border-0">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for permission in permissions %}
                            <tr>
                                <td><code>{{ permission.codename }}</code></td>
                                <td>{{ permission.name }}</td>
                                <td>{{ permission.description|default:"-" }}</td>
                                <td>
                                    {% if request.custom_user|has_perm:'update_permission' %}
                                    <a href="{% url 'update-permission' permission.id %}" class="btn btn-custom-edit btn-sm me-2">Edit</a> {# Changed to custom edit button #}
                                    {% endif %}
                                    {% if request.custom_user|has_perm:'delete_permission' %} 
                                    <form action="{% url 'delete-permission' permission.id %}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this permission?');"> {# Added d-inline and confirmation #}
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center">No permissions found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_head_css %}
{{ block.super }}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css"/>
{% endblock %}

{% block extra_body_scripts %}
{{ block.super }}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure jQuery is available and DataTables are loaded
        if (typeof jQuery != 'undefined' && typeof jQuery.fn.DataTable != 'undefined') {
            $('#permissions-table').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'copyHtml5',
                        exportOptions: {
                            columns: [ 0, 1, 2 ] // Only copy Codename, Name, Description
                        }
                    },
                    {
                        extend: 'csvHtml5',
                        exportOptions: {
                            columns: [ 0, 1, 2 ]
                        }
                    },
                    {
                        extend: 'excelHtml5',
                        exportOptions: {
                            columns: [ 0, 1, 2 ]
                        }
                    },
                    {
                        extend: 'pdfHtml5',
                        exportOptions: {
                            columns: [ 0, 1, 2 ]
                        }
                    },
                    {
                        extend: 'print',
                        exportOptions: {
                            columns: [ 0, 1, 2 ]
                        }
                    }
                ],
                // Disable sorting on the 'Actions' column
                columnDefs: [
                    { orderable: false, targets: 3 }
                ]
            });
        } else {
            console.warn("jQuery or DataTables not loaded, DataTable initialization skipped.");
        }
    });
</script>
{% endblock %}